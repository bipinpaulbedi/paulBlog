<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta name="generator" content="Gatsby 2.0.61"/><title data-react-helmet="true">phoenix/elixir - concurrency actor model with &#x27;let it crash&#x27; philosophy | paul blog</title><meta data-react-helmet="true" name="description" content="A concurrent program has multiple logical threads of control. These threads may or may not run in parallel. A parallel program potentially…"/><link rel="alternate" type="application/rss+xml" href="/rss.xml"/><style data-styled="lguLPz gTOYVM jyCdcQ iuvVkD dDHcQE gwifdm" data-styled-version="4.1.2">
/* sc-component-id: HeaderNav__StyledHeaderNav-wnyhma-0 */
.gTOYVM{float:right;} .gTOYVM li{float:left;list-style:none;padding:1rem 0.5rem;} @media (min-width:46.0625em){.gTOYVM{font-size:1.5rem;}}
/* sc-component-id: Header__StyledHeader-sc-9eu2yh-0 */
.lguLPz{padding:1rem;font-weight:700;}
/* sc-component-id: Footer__StyledFooter-sc-1xqajj9-0 */
.gwifdm{padding:1rem;font-weight:700;text-align:right;}
/* sc-component-id: blog-post__StyledBlog-sc-1g2ojw6-0 */
.jyCdcQ{margin:0 auto;padding:0rem 1rem;} .jyCdcQ div{text-align:justify;} .jyCdcQ ul.navigator{list-style-type:none;text-align:center;} @media (min-width:46.0625em){.jyCdcQ{width:80%;}}
/* sc-component-id: blog-post__StyleBlogSubHeading-sc-1g2ojw6-1 */
.iuvVkD{color:#FF0084;}
/* sc-component-id: blog-post__StyleBlogDate-sc-1g2ojw6-2 */
.dDHcQE{color:#797975;font-style:italic;text-align:right;}</style><link rel="manifest" href="/manifest.webmanifest"/><meta name="theme-color" content="#663399"/><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:100%/1.75 'Merriweather','Georgia',serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:#3A3A38;font-family:'Merriweather','Georgia',serif;font-weight:400;word-wrap:break-word;font-kerning:normal;-moz-font-feature-settings:"kern", "liga", "clig", "calt";-ms-font-feature-settings:"kern", "liga", "clig", "calt";-webkit-font-feature-settings:"kern", "liga", "clig", "calt";font-feature-settings:"kern", "liga", "clig", "calt";}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:Montserrat,sans-serif;font-weight:900;text-rendering:optimizeLegibility;font-size:2.5rem;line-height:1.1;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.73286rem;line-height:1.1;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1.4427rem;line-height:1.1;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.1;letter-spacing:0.140625em;text-transform:uppercase;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.83255rem;line-height:1.1;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;color:inherit;font-family:'Merriweather','Georgia',serif;font-weight:900;text-rendering:optimizeLegibility;font-size:0.75966rem;line-height:1.1;font-style:italic;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}ul{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;list-style:disc;}ol{margin-left:1.75rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:0.85rem;line-height:1.75rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1rem;line-height:1.75rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}blockquote{margin-left:-1.75rem;margin-right:1.75rem;margin-top:0;padding-bottom:0;padding-left:1.42188rem;padding-right:0;padding-top:0;margin-bottom:1.75rem;font-size:1.20112rem;line-height:1.75rem;color:#FF0084;font-style:italic;border-left:0.32813rem solid hsla(0,0%,0%,0.9);}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.75rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.75rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.75rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}li > ul{margin-left:1.75rem;margin-bottom:calc(1.75rem / 2);margin-top:calc(1.75rem / 2);}blockquote *:last-child{margin-bottom:0;}li *:last-child{margin-bottom:0;}p *:last-child{margin-bottom:0;}li > p{margin-bottom:calc(1.75rem / 2);}code{font-size:0.85rem;line-height:1.75rem;color:#FF0084;}kbd{font-size:0.85rem;line-height:1.75rem;}samp{font-size:0.85rem;line-height:1.75rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:"tnum";-moz-font-feature-settings:"tnum";-ms-font-feature-settings:"tnum";-webkit-font-feature-settings:"tnum";padding-left:1.16667rem;padding-right:1.16667rem;padding-top:0.875rem;padding-bottom:calc(0.875rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}blockquote > :last-child{margin-bottom:0;}blockquote cite{font-size:1rem;line-height:1.75rem;color:#3A3A38;font-weight:400;}blockquote cite:before{content:"— ";}ul,ol{margin-left:0;}@media only screen and (max-width:480px){ul,ol{margin-left:1.75rem;}blockquote{margin-left:-1.3125rem;margin-right:0;padding-left:0.98438rem;}}h1,h2,h3,h4,h5,h6{margin-top:3.5rem;}a{box-shadow:0 1px 0 0 currentColor;color:#797975;text-decoration:none;}a:hover,a:active{box-shadow:none;}mark,ins{background:#007acc;color:white;padding:0.10938rem 0.21875rem;text-decoration:none;}</style><link href="//fonts.googleapis.com/css?family=Montserrat:700|Merriweather:400,400i,700,700i,900,900i" rel="stylesheet" type="text/css"/><link as="script" rel="preload" href="/webpack-runtime-c27e1b8ffa27810b1b52.js"/><link as="script" rel="preload" href="/app-1b289e0a916f6c08811e.js"/><link as="script" rel="preload" href="/0-102ece3154cd37a03a3e.js"/><link as="script" rel="preload" href="/component---src-templates-blog-post-js-c059e982b6bfbd6b36d6.js"/><link rel="preload" href="/static/d/884/path---2019-01-04-elixir-concurrency-models-03-a-8e4-YAC1HqIR5tAeszQRiJR44tA15d0.json" as="fetch" crossOrigin="use-credentials"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group"><div class="Header__StyledHeader-sc-9eu2yh-0 lguLPz"><a href="/" aria-label="Home" alt="home"><svg height="60" width="60" version="1.0" viewBox="0 0 512.000000 512.000000" preserveAspectRatio="xMidYMid meet"><g transform="translate(0.000000,512.000000) scale(0.100000,-0.100000)" fill="#000000" stroke="none"><path d="M0 2560 l0 -2560 2560 0 2560 0 0 2560 0 2560 -2560 0 -2560 0 0
-2560z m3317 2231 c167 -42 276 -103 379 -213 69 -74 104 -131 141 -226 21
-55 27 -90 31 -192 5 -143 -10 -239 -56 -349 -147 -349 -572 -592 -1232 -705
-153 -26 -402 -56 -468 -56 l-38 0 -46 -127 c-118 -328 -188 -651 -217 -998
-45 -537 1 -840 149 -985 42 -41 65 -54 131 -75 91 -28 181 -33 235 -10 46 19
133 108 167 172 38 72 58 176 58 307 0 188 -28 251 -198 450 -65 76 -122 144
-128 152 -22 31 70 238 159 357 69 91 169 187 226 218 34 18 60 23 110 23 207
-2 340 -190 435 -614 109 -488 177 -636 309 -671 56 -15 131 2 188 44 64 45
145 141 251 297 101 147 139 179 192 166 37 -10 80 -57 117 -130 40 -78 48
-172 24 -266 -23 -91 -94 -233 -164 -326 -149 -199 -288 -274 -507 -274 -154
1 -333 42 -408 95 -12 8 -25 15 -29 15 -3 0 -25 -35 -48 -78 -105 -196 -305
-364 -515 -431 -249 -80 -595 -91 -847 -27 -332 84 -573 264 -698 521 -92 187
-126 384 -115 650 22 532 143 1050 369 1573 20 46 36 85 36 86 0 2 -51 29
-112 59 -192 96 -293 186 -319 281 -15 55 2 113 38 127 40 15 171 -7 297 -50
149 -51 268 -79 273 -64 11 31 154 273 228 383 337 504 723 812 1135 905 95
22 358 14 467 -14z"></path><path d="M2975 4209 c-154 -54 -368 -249 -542 -494 -65 -93 -195 -306 -190
-312 9 -8 240 48 362 88 157 52 284 114 383 188 94 72 142 128 183 215 25 53
30 78 30 134 0 165 -83 231 -226 181z"></path></g></svg></a><ul class="HeaderNav__StyledHeaderNav-wnyhma-0 gTOYVM"><li><a title="Tags" href="/tags">Tags</a></li></ul></div><div class="blog-post__StyledBlog-sc-1g2ojw6-0 jyCdcQ"><h1><a href="#" alt="{post.frontmatter.title}">phoenix/elixir - concurrency actor model with &#x27;let it crash&#x27; philosophy</a></h1><p class="blog-post__StyleBlogSubHeading-sc-1g2ojw6-1 iuvVkD">concurrent and/or parallel processing model</p><p class="blog-post__StyleBlogDate-sc-1g2ojw6-2 dDHcQE">January 04, 2019</p><div><p>A concurrent program has multiple logical threads of control. These threads may or may not run in parallel. A parallel program potentially runs more quickly than a sequential program by executing different parts of the computation simultaneously (in parallel). It may or may not have more than one logical thread of control. An alternative way of thinking about this is that concurrency is an aspect of the problem domain—your program needs to handle multiple simultaneous (or near-simultaneous) events. Parallelism, by contrast, is an aspect of the solution domain—you want to make your program faster by processing different portions of the problem in parallel.</p>
<p>Functional programming avoids the problems associated with shared mutable state by avoiding mutable state. Actor programming, by contrast, retains mutable state but avoids sharing it. An actor is like an object in an object-oriented (OO) program—it encapsulates state and communicates with other actors by exchanging messages. The difference is that actors run concurrently with each other and, unlike OO-style message passing (which is really just calling a method), actors really communicate by sending messages to each other.</p>
<p>Certainly, there are some concurrent programs that will always be nondeterministic. And this is unavoidable—some problems require solutions that are intrinsically dependent on the details of timing. But it’s not the case that all parallel programs are necessarily nondeterministic. The value of the sum of the numbers between 0 and 10,000 won’t change just because we add those numbers together in parallel instead of sequentially</p>
<p>Microsoft <a href="https://dotnet.github.io/orleans/">Orleans</a> is .net implementation of Actor Model but we will focus on programming language which was build with focus on concurrent execution. Elixir/Erlang: Erlang is a programming language used to build massively scalable soft real-time systems with requirements on high availability. Some of its uses are in telecoms, banking, e-commerce, computer telephony and instant messaging. Erlang’s runtime system has built-in support for concurrency, distribution and fault tolerance.
OTP is set of Erlang libraries and design principles providing middle-ware to develop these systems. It includes its own distributed database, applications to interface towards other languages, debugging and release handling tools. Erlang runs on VM called BEAM which is essentially a <a href="https://en.wikipedia.org/wiki/Virtual_machine">process virtual machine</a></p>
<blockquote>
<p>In Erlang, and therefore Elixir, an actor is called a process. In most environments a process is a heavyweight entity that consumes lots of resources and is expensive to create. An Elixir process, by contrast, is very lightweight—lighter weight even than most systems’ threads, both in terms of resource consumption and startup cost. Elixir programs typically create thousands of processes without problems and don’t normally need to resort to the equivalent of thread pools</p>
</blockquote>
<p><strong>Elixir actor by example</strong>  </p>
<p>Elixir actors communicate via message passing using mailboxes, which are queues by data structure. For our example we will create a md5 hash generator which based on a string return a md5 value of string. If the value is already exiting it will not recompute to save cpu resource but send it from in memory cache.</p>
<p><code class="language-text">defmodule HashIt do</code><br>
   <code class="language-text">def loop do</code><br>
       <code class="language-text">receive do</code><br>
           <code class="language-text">{:compute, value} -&gt; IO.puts(&quot;#{value}&quot;)</code> will replace #{value} with computed hash function<br>
       <code class="language-text">end</code><br>
       <code class="language-text">loop</code><br>
   <code class="language-text">end</code><br>
<code class="language-text">end</code><br>
<code class="language-text">----------</code><br>
<code class="language-text">pid = spawn(&amp;HashIt.loop/0)</code><br>
<code class="language-text">send(pid, {:compute, &quot;bipin&quot;})</code><br>
<code class="language-text">sleep(1000)</code>  </p>
<p>This function implements an infinite loop by calling itself recursively. The receive block waits for a message and then uses pattern matching to work out how to handle it.  Elixir implements tail-call elimination. Tail-call elimination, as its name suggests, replaces a recursive call with a simple jump if the last thing the function does is call itself, thus infinite recursive call o loop function will not result in stack overflow.</p>
<p><code class="language-text">defmodule HashIt do</code><br>
   <code class="language-text">def loop do</code><br>
       <code class="language-text">receive do</code><br>
           <code class="language-text">{:compute, value} -&gt; IO.puts(:crypto.hash(:md5, value) |&gt; Base.encode16())</code><br>
           <code class="language-text">{:shutdown} -&gt;  -&gt; exit(:normal)</code><br>
       <code class="language-text">end</code><br>
       <code class="language-text">loop</code><br>
   <code class="language-text">end</code><br>
<code class="language-text">end</code><br>
<code class="language-text">----------</code><br>
<code class="language-text">receive do</code><br>
   <code class="language-text">{:EXIT, ^pid, reason} -&gt; IO.puts(&quot;HasIt has exited (#{reason})&quot;)</code><br>
<code class="language-text">end</code></p>
<p><code class="language-text">Process.flag(:trap_exit, true)</code><br>
<code class="language-text">pid = spawn_link(&amp;HashIt.loop/0)</code><br>
<code class="language-text">send(pid, {:compute, &quot;bipin&quot;})</code><br>
<code class="language-text">send(pid, {:shutdown}</code>  </p>
<p><strong>Adding state to the actor</strong>  </p>
<p>We will add a variable to store all values sent and their computed hash</p>
<p><code class="language-text">defmodule HashIt do</code><br>
   <code class="language-text">def loop(strg) do</code><br>
       <code class="language-text">receive do</code><br>
           <code class="language-text">{:compute, value} -&gt;</code><br>
               <code class="language-text">hashValue = :crypto.hash(:md5 , value) |&gt; Base.encode16()</code><br>
               <code class="language-text">updatedStrg = strg.put(strg, value, hashValue)</code><br>
               <code class="language-text">IO.puts(hashValue)</code><br>
               <code class="language-text">loop(updatedStrg)</code><br>
       <code class="language-text">end</code><br>
       <code class="language-text">loop</code><br>
   <code class="language-text">end</code><br>
<code class="language-text">end</code>  </p>
<p>Here Strg is an elixir Map and we can start the process by using  </p>
<p><code class="language-text">pid = spawn(HashIt, :loop, [%{}])</code>  </p>
<p>or we can define methods to start, compute also provide it a name instead of using pid by registering it.  </p>
<p><code class="language-text">defmodule HashIt do</code><br>
   <code class="language-text">def start(name, strg, cryptoType) do</code><br>
       <code class="language-text">pid = spawn(__MODULE__, :loop, [strg, cryptoType])</code><br>
       <code class="language-text">Process.register(pid, name)</code><br>
       <code class="language-text">pid</code><br>
   <code class="language-text">end</code><br>
   <code class="language-text">def compute(name, value) do</code><br>
       <code class="language-text">ref = make_ref()</code><br>
       <code class="language-text">send(name, {:compute, value, self(), ref})</code><br>
       <code class="language-text">receive do</code><br>
           <code class="language-text">{:ok, ^ref, reply} -&gt; reply</code><br>
       <code class="language-text">end</code><br>
   <code class="language-text">end</code><br>
   <code class="language-text">def loop(strg, cryptoType) do</code><br>
       <code class="language-text">receive do</code><br>
           <code class="language-text">{:compute, value, sender, ref} -&gt;</code><br>
               <code class="language-text">hashValue = :crypto.hash(cryptoType , value) |&gt; Base.encode16()</code><br>
               <code class="language-text">updatedStrg = Map.put_new(strg, value, hashValue)</code><br>
               <code class="language-text">send(sender, {:ok, ref, hashValue})</code><br>
               <code class="language-text">loop(updatedStrg, cryptoType)</code><br>
       <code class="language-text">end</code><br>
       <code class="language-text">loop</code><br>
   <code class="language-text">end</code><br>
<code class="language-text">end</code>  </p>
<p>The program can be started via start method and uses pseudo-variable <strong>MODULE</strong>, which evaluates to the name of the current module. The Process.register registers the pid as name :hashit. Moreover instead of printing the hash value it now returns it to the sender, which helps in bi-directional communication. The carot ^ symbol in {:ok, ^ref, reply} denotes we want to match the value rather than binding it. The <a href="https://elixir-lang.org/getting-started/pattern-matching.html">pattern matching</a> in elixir is used to match inside a data structure. Effectively we can now execute the HashIt module via</p>
<p><code class="language-text">:hashItMD5 |&gt; HashIt.start([%{}, :md5])</code><br>
<code class="language-text">:hashItMD5 |&gt; HashIt.compute(&quot;bipin&quot;)</code></p>
<p><strong>Adding check and compute logic</strong>  </p>
<p>Adding the return value to check in cache before recomputing above module can be refactured as</p>
<p><code class="language-text">defmodule HashIt do</code><br>
   <code class="language-text">def start(name, strg, cryptoType) do</code><br>
       <code class="language-text">pid = spawn(__MODULE__, :loop, [strg, cryptoType])</code><br>
       <code class="language-text">Process.register(pid, name)</code><br>
       <code class="language-text">pid</code><br>
   <code class="language-text">end</code><br>
   <code class="language-text">def compute(name, value) do</code><br>
       <code class="language-text">ref = make_ref()</code><br>
       <code class="language-text">send(name, {:compute, value, self(), ref})</code><br>
       <code class="language-text">receive do</code><br>
           <code class="language-text">{:ok, ^ref, reply} -&gt; reply</code><br>
       <code class="language-text">end</code><br>
   <code class="language-text">end</code><br>
   <code class="language-text">def loop(strg, cryptoType) do</code><br>
       <code class="language-text">receive do</code><br>
           <code class="language-text">{:compute, value, sender, ref} -&gt;</code><br>
               <code class="language-text">result = Map.fetch(strg, value)</code><br>
               <code class="language-text">case result do</code><br>
                   <code class="language-text">{:ok, val} -&gt; send(sender, {:ok, ref, val})</code><br>
                        <code class="language-text">loop(strg, cryptoType)</code><br>
                   <code class="language-text">{:error, _reason} -&gt;</code><br>
                        <code class="language-text">hashValue = :crypto.hash(cryptoType , value) |&gt; Base.encode16()</code><br>
                        <code class="language-text">updatedStrg = Map.put_new(strg, value, hashValue)</code><br>
                        <code class="language-text">send(sender, {:ok, ref, hashValue})</code><br>
                        <code class="language-text">loop(updatedStrg, cryptoType)</code><br>
               <code class="language-text">end</code><br>
       <code class="language-text">end</code><br>
       <code class="language-text">loop</code><br>
   <code class="language-text">end</code><br>
<code class="language-text">end</code>  </p>
<p><strong>Making it fault tolerant</strong>  </p>
<p>Thus various processes can be started in parallel for different crypto compute example MD5, SHA128, SHA256. Using the above process mechanism we can create multiple processes for different or same task resulting in both concurrent and parallel deterministic outputs. But this architecture does not provide fault tolerance. What is there is an error and it is aborted abruptly ? Elixir provides a mechanism to link to process which is by directional.  </p>
<p><code class="language-text">:hashItMD5 |&gt; HashIt.start([%{}, :md5])</code><br>
<code class="language-text">:hashItSHA256 |&gt; HashIt.start([%{}, :sha256])</code><br>
<code class="language-text">:hashItMD5 |&gt; Process.link(:hashItSHA256)</code><br>
<code class="language-text">:hashItMD5 |&gt; exit(:forced_kill)</code>  </p>
<p>Since we are using spawn in our hashWe can also use spawn_link method to link process instead of process.link. Please note links created are bi directional. and calling abnormal exit on :hashItMD5 will also set :hashItSHA256 to nil  </p>
<p><code class="language-text">Process.info(:hashItMD5, :status)</code><br>
<small>nil</small><br>
<code class="language-text">Process.info(:hashItSHA256, :status)</code><br>
<small>nil</small>  </p>
<p>but normal exit will keep the linked process active, viz:<br>
<code class="language-text">:hashItMD5 |&gt; exit(:normal)</code><br>
<code class="language-text">Process.info(:hashItMD5, :status)</code><br>
<small>nil</small><br>
<code class="language-text">Process.info(:hashItSHA256, :status)</code><br>
<small>{:status, :waiting}</small>  </p>
<p>This implies we can set the system trap to capture other processes exit, when can be utilized to create supervisor and re start the system if the process crashes. We can set Process.flag(:trap_exit, true) to capture the exit of linked process and take appropriate action. In our example of HashIt a supervisor can be created as:  </p>
<p><code class="language-text">defmodule HashItSupervisor do</code><br>
   <code class="language-text">def start do</code><br>
       <code class="language-text">spawn(__MODULE__, :loop_system,[])</code><br>
   <code class="language-text">end</code><br>
   <code class="language-text">def loop_system do</code><br>
       <code class="language-text">Process.flag(:trap_exit, true)</code><br>
       <code class="language-text">loop</code><br>
   <code class="language-text">end</code><br>
   <code class="language-text">def loop do</code><br>
       <code class="language-text">pid = HashIt.start(%{}, :md5)</code> // instead of using spawn please change it to spawn_link in HashIt module<br>
       <code class="language-text">receive do</code><br>
           <code class="language-text">{:EXIT, ^pid, :normal} -&gt; IO.puts(&quot;Hash It exited normally&quot;)</code><br>
               <code class="language-text">:ok</code><br>
           <code class="language-text">{:EXIT, ^pid, reason} -&gt; IO.puts(&quot;Hash It failed with reason #{inspect reason}...restarting&quot;)</code><br>
               <code class="language-text">loop</code><br>
       <code class="language-text">end</code><br>
   <code class="language-text">end</code><br>
<code class="language-text">end</code><br>
<code class="language-text">----------</code><br>
<code class="language-text">HashItSupervisor.start</code>  </p>
<p>If the HashIt system now crashes it is captured by HashItSupervisor and is restarted. If the two processes are dependent on each other and can result in deadlock or infinite waiting because of crashing of sender the receiver can be guarded using timeout clause in receive do loop by using after clause. example:</p>
<p><code class="language-text">receive do</code><br>
   <code class="language-text">{:ok, ^ref, value} -&gt; IO.puts(value)</code><br>
   <code class="language-text">after 1000 -&gt; nil</code><br>
<code class="language-text">end</code>  </p>
<p><strong>Scaling to multiple nodes/computers</strong>  </p>
<p>The actor programming naturally supports an approach to writing fault-tolerant code that leverages this observation: the error-kernel pattern. In the elixir system the kernel is the root supervisor which can start other supervisors or workers. When we create an elixir virtual machine we create a node we can create nodes multiple nodes on same system or on network of computer by naming them using —name or —sname option. To make multiple nodes part of same cluster it must use same —cookie name argument. This results in running your system across multiple systems. To multiple connect nodes we can use connect function</p>
<p><code class="language-text">iex(node1@192.168.0.10)1&gt; Node.self</code><br>
<small>:“node1@192.168.0.10”</small><br>
<code class="language-text">iex(node1@192.168.0.10)2&gt; Node.list</code><br>
<small>[]</small><br>
<code class="language-text">iex(node1@192.168.0.10)3&gt; Node.connect(:&quot;node2@192.168.0.20&quot;)</code><br>
<small>true</small><br>
<code class="language-text">iex(node1@192.168.0.10)4&gt; Node.list</code><br>
<small>[:“node2@192.168.0.20”]</small>  </p>
<p>Now use Node.Spwan to start worker or supervisors and use :global.register_name() instead of Process.register() to make names cluster global. </p>
<p><strong>Important notes</strong>  </p>
<p>For this explanatory purpose we used dynamic atom naming above. However, naming dynamic processes with atoms is a terrible idea! If we use atoms, we would need to convert the name (often received from an external client) to atoms, and we should never convert user input to atoms. This is because atoms are not garbage collected. Once an atom is created, it is never reclaimed. Generating atoms from user input would mean the user can inject enough different names to exhaust our system memory!  </p>
<p>In practice, it is more likely you will reach the Erlang VM limit for the maximum number of atoms before you run out of memory, which will bring your system down regardless. Moreover Supervisor model used above can result in inconsistent naming convention across various modules and libraries. Thus elixir provides a standard protocol to defining,starting and maintaining workers using efficient bucketed methodology using <a href="https://elixir-lang.org/getting-started/mix-otp/genserver.html">GenServer</a>, providing standard call, cast and info method implementation for various operation.</p></div><p><a href="/categories/technology" alt="technology">technology</a></p><div id="disqus_thread"></div><hr/><ul class="navigator"><li><a rel="prev" href="/2018-10-20-asymtotic-notations/">← <!-- -->ELI5 - Asymptotic computational complexity simplified</a></li><li></li></ul></div><div class="Footer__StyledFooter-sc-1xqajj9-0 gwifdm">powered by | <a href="https://reactjs.org/" alt="react">react</a> | <a href="https://www.gatsbyjs.org/">gatsby</a> | <a href="https://github.com/">github</a></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.page={"componentChunkName":"component---src-templates-blog-post-js","jsonName":"2019-01-04-elixir-concurrency-models-03a","path":"/2019-01-04-elixir-concurrency-models/"};window.dataPath="884/path---2019-01-04-elixir-concurrency-models-03-a-8e4-YAC1HqIR5tAeszQRiJR44tA15d0";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-1b289e0a916f6c08811e.js"],"component---node-modules-gatsby-plugin-offline-app-shell-js":["/component---node-modules-gatsby-plugin-offline-app-shell-js-15a722f0c1c66f04d507.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-c059e982b6bfbd6b36d6.js"],"component---src-templates-blog-tags-js":["/component---src-templates-blog-tags-js-0507932c14a36cdffb17.js"],"component---src-templates-blog-categories-js":["/component---src-templates-blog-categories-js-329f8e40dbd361292ba7.js"],"component---src-pages-404-js":["/component---src-pages-404-js-a3f7951a5351dfe26a09.js"],"component---src-pages-index-js":["/component---src-pages-index-js-2c23c9bd2ce357711fd0.js"],"component---src-pages-tags-js":["/component---src-pages-tags-js-d67da2e3a9e02ca4fa0d.js"]};/*]]>*/</script><script src="/component---src-templates-blog-post-js-c059e982b6bfbd6b36d6.js" async=""></script><script src="/0-102ece3154cd37a03a3e.js" async=""></script><script src="/app-1b289e0a916f6c08811e.js" async=""></script><script src="/webpack-runtime-c27e1b8ffa27810b1b52.js" async=""></script></body></html>